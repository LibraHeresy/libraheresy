import{_ as s,c as a,o as n,V as l}from"./chunks/framework.0cefc241.js";const C=JSON.parse('{"title":"企业微信使用微信jssdk实现转发功能","description":"","frontmatter":{},"headers":[],"relativePath":"blog/企业微信使用微信jssdk实现转发功能/page.md","lastUpdated":1684822237000}'),p={name:"blog/企业微信使用微信jssdk实现转发功能/page.md"},o=l(`<h1 id="企业微信使用微信jssdk实现转发功能" tabindex="-1">企业微信使用微信jssdk实现转发功能 <a class="header-anchor" href="#企业微信使用微信jssdk实现转发功能" aria-label="Permalink to &quot;企业微信使用微信jssdk实现转发功能&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>又接到一个看似简单，实则难受的需求，实现企业微信环境转发H5页面到微信好友和朋友圈，并保留卡片形式。</p><p>需求简单明了，但是和微信沾边的，都不是一条好走的路。</p><p>一上手就发现问题了，企微的<code>jssdk</code>它不更新了。兜兜转转发现，好像企微和微信的<code>jssdk</code>统一用<code>@wecom/jssdk</code>。</p><p>果然不愧是微信啊，张小龙NB。</p><p>而我在发现这个状况之前已经用了第三方封装的包，<code>weixin-js-sdk</code>。幸好问题不大，因为这个包只是将官方js-sdk转为了CommonJS格式。</p><p>但我的建议是使用<code>@wecom/jssdk</code>，因为我已经发现有些方法<code>weixin-js-sdk</code>并不支持，比如<code>updateAppMessageShareData</code>和<code>updateTimelineShareData</code>，这两个新的分享方法。</p><h2 id="环境" tabindex="-1">环境 <a class="header-anchor" href="#环境" aria-label="Permalink to &quot;环境&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">环境</p><p>企业微信 4.1.3(21966)</p><p>weixin-js-sdk 1.6.0</p></div><h2 id="实现" tabindex="-1">实现 <a class="header-anchor" href="#实现" aria-label="Permalink to &quot;实现&quot;">​</a></h2><h3 id="引入微信jssdk" tabindex="-1">引入微信jssdk <a class="header-anchor" href="#引入微信jssdk" aria-label="Permalink to &quot;引入微信jssdk&quot;">​</a></h3><p>我说我怎么引入的这么难受呢。。。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// terminal</span></span>
<span class="line"><span style="color:#A6ACCD;">npm install weixin</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">js</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">sdk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// updateShare.js</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#A6ACCD;"> wx </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">weixin-js-sdk</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><h3 id="注册企微接口权限" tabindex="-1">注册企微接口权限 <a class="header-anchor" href="#注册企微接口权限" aria-label="Permalink to &quot;注册企微接口权限&quot;">​</a></h3><p>这一步其实挺简单的，调用wx.config接口就行，重点是参数的获取，还有就是注册以后的<code>url</code>不会变动了，如果切换页面你就要重新注册一次。</p><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#0" target="_blank" rel="noreferrer">JS-SDK说明文档</a></p><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#62" target="_blank" rel="noreferrer">附录1-JS-SDK使用权限签名算法</a></p><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html#63" target="_blank" rel="noreferrer">附录2-所有JS接口列表</a></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 注册接口权限</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> jsapiTicket </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 我是后端返回的，前端也可以自己获取，具体的看附录1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> timestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Number</span><span style="color:#A6ACCD;">((Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#A6ACCD;">())</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">substring</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">)) </span><span style="color:#676E95;font-style:italic;">// 获取时间戳</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> nonceStr </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getuuid</span><span style="color:#A6ACCD;">() </span><span style="color:#676E95;font-style:italic;">// 获取uuid</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> url </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 注册成功以后回调网址</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> signature </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> CryptoJS</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SHA1</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">jsapi_ticket=</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">jsapiTicket</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">&amp;noncestr=</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">nonceStr</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">&amp;timestamp=</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">timestamp</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">&amp;url=</span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">url</span><span style="color:#89DDFF;">}\`</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">() </span><span style="color:#676E95;font-style:italic;">// 生成签名</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">wx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">config</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">debug</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 是否开启调试模式，开启的话，每调用一次api就会回调弹出结果弹窗。</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">appId</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 填写企业号corpid，但是要注意的是，如果改网页被分享到微信，那你就要用微信公众号的appid才能获取到接口权限</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">timestamp</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 必填，生成签名的时间戳。注意！微信要的时间戳精度是到秒</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">nonceStr</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 必填，生成签名的随机串。随便一个uuid就行，只要是不重复的随机串都可以。</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">signature</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 必填，签名，见附录1。</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">jsApiList</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> [] </span><span style="color:#676E95;font-style:italic;">// 必填，需要使用的JS接口列表，所有JS接口列表见附录2。</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 成功回调</span></span>
<span class="line"><span style="color:#A6ACCD;">wx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ready</span><span style="color:#A6ACCD;">(</span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// config信息验证失败会执行ready函数</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 检查环境支持api</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">wx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">checkJsApi</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    jsApiList</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">success</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">function</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">res</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 失败回调</span></span>
<span class="line"><span style="color:#A6ACCD;">wx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">error</span><span style="color:#A6ACCD;">(</span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">err</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的err参数中查看，对于SPA可以在这里更新签名。</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h3 id="调用分享接口" tabindex="-1">调用分享接口 <a class="header-anchor" href="#调用分享接口" aria-label="Permalink to &quot;调用分享接口&quot;">​</a></h3><p>最难的就是注册接口权限了，如果你成功了，那接下来就是一片坦途。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> config </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 分享卡片标题</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">desc</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 分享卡片描述</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">imgUrl</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 分享卡片头像</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">link</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 分享卡片点击打开的网址</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">success</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 用户确认分享后执行的回调函数</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">cancel</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 用户取消分享后执行的回调函数</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">。</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 分享接口的入参都差不多</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 分享到微信，即将废弃</span></span>
<span class="line"><span style="color:#A6ACCD;">wx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onMenuShareAppMessage</span><span style="color:#A6ACCD;">(config)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 分享到朋友圈，即将废弃</span></span>
<span class="line"><span style="color:#A6ACCD;">wx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onMenuShareTimeline</span><span style="color:#A6ACCD;">(config)</span></span></code></pre></div><h2 id="问题" tabindex="-1">问题 <a class="header-anchor" href="#问题" aria-label="Permalink to &quot;问题&quot;">​</a></h2><h3 id="再次分享卡片头像图不加载" tabindex="-1">再次分享卡片头像图不加载 <a class="header-anchor" href="#再次分享卡片头像图不加载" aria-label="Permalink to &quot;再次分享卡片头像图不加载&quot;">​</a></h3><p>常见原因就是你的头像图太大，导致加载失败，最好控制在200k以内，还有就是你的头像图链接挂了咯。</p><h3 id="错误码-63002-invalid-signature" tabindex="-1">错误码:63002,invalid signature <a class="header-anchor" href="#错误码-63002-invalid-signature" aria-label="Permalink to &quot;错误码:63002,invalid signature&quot;">​</a></h3><p>如果你确定你的<code>noncestr</code>和<code>jsapi_ticket</code>没有问题，但就是提示非法签名，那可能是因为你的<code>timestamp</code>。</p><p>因为微信TM的<code>timestamp</code>精度是到秒，而JS的<code>Date.now()</code>方法精度是到毫秒。</p><p>真不愧是你啊，微信。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> js_timestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> wx_timestamp </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Number</span><span style="color:#A6ACCD;">((Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#A6ACCD;">())</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">substring</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">)) </span><span style="color:#676E95;font-style:italic;">// 需要这样处理</span></span></code></pre></div>`,31),e=[o];function t(c,r,y,D,i,A){return n(),a("div",null,e)}const d=s(p,[["render",t]]);export{C as __pageData,d as default};

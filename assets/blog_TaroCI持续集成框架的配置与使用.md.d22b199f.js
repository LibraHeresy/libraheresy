import{_ as s,c as a,o as n,V as l}from"./chunks/framework.0cefc241.js";const h=JSON.parse('{"title":"Taro CI 持续集成框架的配置与使用","description":"","frontmatter":{},"headers":[],"relativePath":"blog/TaroCI持续集成框架的配置与使用.md","lastUpdated":1685346339000}'),o={name:"blog/TaroCI持续集成框架的配置与使用.md"},p=l(`<h1 id="taro-ci-持续集成框架的配置与使用" tabindex="-1">Taro CI 持续集成框架的配置与使用 <a class="header-anchor" href="#taro-ci-持续集成框架的配置与使用" aria-label="Permalink to &quot;Taro CI 持续集成框架的配置与使用&quot;">​</a></h1><h2 id="痛点" tabindex="-1">痛点 <a class="header-anchor" href="#痛点" aria-label="Permalink to &quot;痛点&quot;">​</a></h2><p>使用 <code>Taro</code> 跨端框架开发小程序时，需要切换三个界面，进行三次操作，才能上传成功，上传代码步骤过于繁琐。</p><p>且多人开发时，如果想让自己代码生效，需要切换体验版代码为自己上传的版本。</p><div class="tip custom-block"><p class="custom-block-title">步骤</p><p>vscode 打包 -&gt; 微信开发者工具上传 -&gt; 设置为体验版</p></div><h2 id="方案" tabindex="-1">方案 <a class="header-anchor" href="#方案" aria-label="Permalink to &quot;方案&quot;">​</a></h2><p>使用微信官方的 <code>CI</code> 插件包，即可实现命令行上传代码。</p><p>因为我使用的 <code>Taro</code> 本身就有 <code>Taro CI</code>，和 <code>Taro</code> 一样兼容了各个小程序平台，所以直接使用 <code>Taro</code> 提供的即可。</p><div class="tip custom-block"><p class="custom-block-title">步骤</p><p>配置上传信息 -&gt; vscode 命令行打包上传</p></div><p><code>Taro CI</code> 完美解决我的痛点，而且因为是机器人上传，所以大家代码都可以上传到同一个体验版内，也不用切换界面，vscode 终端一行命令就可以完成打包上传操作。</p><h2 id="环境" tabindex="-1">环境 <a class="header-anchor" href="#环境" aria-label="Permalink to &quot;环境&quot;">​</a></h2><div class="tip custom-block"><p class="custom-block-title">环境</p><p>node: 14.17.3</p><p>Taro: 3.0.21</p><p>Taro CI: 3.5.3</p></div><h2 id="实现" tabindex="-1">实现 <a class="header-anchor" href="#实现" aria-label="Permalink to &quot;实现&quot;">​</a></h2><h3 id="安装-tarojs-plugin-mini-ci" tabindex="-1">安装 <code>tarojs/plugin-mini-ci</code> <a class="header-anchor" href="#安装-tarojs-plugin-mini-ci" aria-label="Permalink to &quot;安装 \`tarojs/plugin-mini-ci\`&quot;">​</a></h3><div class="language-cmd"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">yarn </span><span style="color:#82AAFF;">add</span><span style="color:#A6ACCD;"> @tarojs/plugin</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">mini</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">ci </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">D</span></span></code></pre></div><p>或</p><div class="language-cmd"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">npm i @tarojs/plugin</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">mini</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">ci </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">D</span></span></code></pre></div><h3 id="配置参数" tabindex="-1">配置参数 <a class="header-anchor" href="#配置参数" aria-label="Permalink to &quot;配置参数&quot;">​</a></h3><p>按照官方文档配置本地参数就可以了</p><p><a href="https://taro-docs.jd.com/docs/plugin-mini-ci" target="_blank" rel="noreferrer">Taro CI 官方文档</a></p><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><h3 id="打包报错" tabindex="-1">打包报错 <a class="header-anchor" href="#打包报错" aria-label="Permalink to &quot;打包报错&quot;">​</a></h3><p>UnhandledPromiseRejectionWarning: TypeError: Cannot read property &#39;platform&#39; of undefined <img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291522436.png" alt="异常" title="\`Taro CI\`异常"> 此报错的原因是插件本身取值对象有问题，所以我们需要修改它的取值对象。</p><p><code>文件路径：node_modules\\@tarojs\\plugin-mini-ci\\dist\\index.js 51行</code></p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> platform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">runOpts</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">options</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">platform</span><span style="color:#89DDFF;">;</span></span></code></pre></div><p>修改为</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> platform </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">runOpts</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">platform</span><span style="color:#89DDFF;">;</span></span></code></pre></div><h3 id="申请插件权限" tabindex="-1">申请插件权限 <a class="header-anchor" href="#申请插件权限" aria-label="Permalink to &quot;申请插件权限&quot;">​</a></h3><p>插件安装以后是不能直接使用的（有时候也可以。。。），需要申请插件权限，需要用到 <code>PostMan</code> 等可以模拟请求的工具。</p><p><a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/plugin-management/managePlugin.html" target="_blank" rel="noreferrer">向插件开发者发起使用插件的申请</a></p><h4 id="_1-获取-access-token" tabindex="-1">1. 获取 <code>access_token</code> <a class="header-anchor" href="#_1-获取-access-token" aria-label="Permalink to &quot;1. 获取 \`access_token\`&quot;">​</a></h4><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 请求方式</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">method</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">GET</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 请求地址</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">url</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://api.weixin.qq.com/cgi-bin/token</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 请求参数</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">param</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">grant_type</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">client_credential</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 固定值</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">appid</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 小程序 id</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">secret</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 小程序密钥</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 示例</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">example</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=123&amp;secret=123</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h4 id="_2-申请插件权限" tabindex="-1">2. 申请插件权限 <a class="header-anchor" href="#_2-申请插件权限" aria-label="Permalink to &quot;2. 申请插件权限&quot;">​</a></h4><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 请求方式</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">method</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">POST</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 请求地址</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">url</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://api.weixin.qq.com/wxa/plugin</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 请求参数</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#FFCB6B;">param</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">access_token</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">client_credential</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// token</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">action</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">apply</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 固定值</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#FFCB6B;">plugin_appid</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 小程序 id</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h3 id="ip-白名单" tabindex="-1">IP 白名单 <a class="header-anchor" href="#ip-白名单" aria-label="Permalink to &quot;IP 白名单&quot;">​</a></h3><p>有时候会提示 ip 地址非法，是因为小程序默认开启了 <code>ip</code> 白名单，所以不能上传。这时候就需要添加 <code>ip</code> 地址到白名单或者关闭白名单。</p><p>在这推荐的是关闭白名单，因为添加 <code>ip</code> 白名单需要管理员权限，这是安全与效率的取舍。</p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291522352.png" alt="白名单" title="白名单"></p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291522782.png" alt="白名单" title="白名单"></p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291522228.png" alt="白名单" title="白名单"></p><h3 id="关于其他参数配置" tabindex="-1">关于其他参数配置 <a class="header-anchor" href="#关于其他参数配置" aria-label="Permalink to &quot;关于其他参数配置&quot;">​</a></h3><p>因为 <code>Taro CI</code> 就是各家小程序持续集成插件的封装，所以各个小程序的配置参数理论上都可以使用，但是因为 <code>Taro CI</code> 并没有开放出来，所以当我们有自定义需求时，只能直接修改插件包。</p><p><a href="https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html" target="_blank" rel="noreferrer">微信小程序 CI 文档</a></p><p>比如我们给微信小程序添加一个压缩参数：</p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291523909.png" alt="文档" title="文档"></p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291523360.png" alt="文档" title="文档"></p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291523272.png" alt="文档" title="文档"></p><p>我们可以看到小程序官方 <code>CI</code> 的配置数据结构，接下来我们看看 <code>Taro CI</code> 的：</p><p><code>文件路径：node_modules\\@tarojs\\plugin-mini-ci\\dist\\WeappCI.js</code></p><p><img src="https://cdn.jsdelivr.net/gh/LibraHeresy/BaiduNetDisk/blog-images/202305291523799.png" alt="源码" title="源码"></p><p>简直是一模一样，所以我直接把我需要的配置写入，测试成功。</p>`,51),e=[p];function t(c,r,i,F,y,d){return n(),a("div",null,e)}const m=s(o,[["render",t]]);export{h as __pageData,m as default};
